<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Remove default IIS static file handler for clean routing -->
    <handlers>
      <remove name="StaticFile" />
      <add name="StaticFile" path="*" verb="*" modules="StaticFileModule" resourceType="Unspecified" requireAccess="Read" />
    </handlers>

    <!-- Ensure Node is used to serve the app -->
    <rewrite>
      <rules>
        <!-- Ignore next.js build/static files -->
        <rule name="NextStatic" stopProcessing="true">
          <match url="^_next/.*" />
          <conditions logicalGrouping="MatchAll" trackAllCaptures="false" />
          <action type="None" />
        </rule>

        <!-- Ignore static files in public folder -->
        <rule name="PublicStatic" stopProcessing="true">
          <match url="^.*\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot)$" />
          <action type="None" />
        </rule>

        <!-- Route all other requests to Next.js server -->
        <rule name="NextApp" stopProcessing="true">
          <match url=".*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- Increase max upload size if needed -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="52428800" /> <!-- 50 MB -->
      </requestFiltering>
    </security>
  </system.webServer>
</configuration>
